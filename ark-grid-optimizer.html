<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„í¬ê·¸ë¦¬ë“œ ìµœì í™” ì‹œë®¬ë ˆì´í„°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f8fafc;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 16px;
        }

        .page-switcher {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .page-switcher button {
            padding: 8px 20px;
            background-color: rgba(255,255,255,0.1);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            margin: 0 4px;
        }

        .page-switcher button.active {
            background-color: rgba(255,255,255,0.3);
        }

        .page-switcher button:hover {
            background-color: rgba(255,255,255,0.2);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 16px;
            background-color: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background-color: rgba(255,255,255,0.3);
        }

        .section {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 24px;
            color: #2d3748;
        }

        .core-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .core-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            background-color: #fafafa;
            transition: all 0.2s ease;
        }

        .core-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .core-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 12px;
        }

        .core-icon.sun { background-color: #f59e0b; }
        .core-icon.moon { background-color: #8b5cf6; }
        .core-icon.star { background-color: #10b981; }

        .core-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 8px;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            font-size: 1rem;
            background-color: white;
            cursor: pointer;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .form-input:focus, .form-select:focus {
            border-color: #667eea;
        }

        .core-limit {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .gem-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            justify-content: start;
        }

        .gem-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            background-color: white;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
        }

        .gem-card.selected {
            border-color: #667eea;
            background-color: #f0f4ff;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .gem-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .gem-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .gem-stats {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .gem-option {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 6px;
        }

        .gem-option-label {
            font-size: 0.875rem;
            color: #4a5568;
            font-weight: 500;
            min-width: 60px;
        }

        .gem-option-value {
            font-size: 0.875rem;
            color: #2d3748;
            font-weight: 600;
        }

        .gem-total {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
            padding: 8px;
            background-color: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .gem-total-value {
            font-size: 0.875rem;
            color: #059669;
            font-weight: 600;
        }

        .gem-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.75rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-edit {
            background-color: #f59e0b;
            color: white;
        }

        .btn-edit:hover {
            background-color: #d97706;
        }

        .btn-delete {
            background-color: #ef4444;
            color: white;
        }

        .btn-delete:hover {
            background-color: #dc2626;
        }

        .add-form {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            background-color: #f8fafc;
        }

        .add-form h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2d3748;
        }

        .form-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            flex-wrap: wrap;
            margin-bottom: 20px;
            justify-content: flex-start;
        }

        .form-field {
            display: flex;
            flex-direction: column;
        }

        .form-field.small {
            width: 60px;
        }

        .form-field.medium {
            min-width: 120px;
        }

        .form-field label {
            font-size: 0.75rem;
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 4px;
        }

        .form-field input, .form-field select {
            padding: 8px;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .form-field input:focus, .form-field select:focus {
            border-color: #667eea;
        }

        .form-buttons {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .btn-primary {
            background-color: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-primary:hover {
            background-color: #059669;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .optimize-btn {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .btn-optimize {
            padding: 16px 32px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.125rem;
            font-weight: 600;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            transform: translateY(0);
        }

        .btn-optimize:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            justify-content: start;
        }

        .result-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            background-color: #fafafa;
            transition: all 0.2s ease;
        }

        .result-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .result-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 12px;
        }

        .result-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2d3748;
        }

        .result-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: white;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid #e2e8f0;
        }

        .stat-group {
            text-align: center;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 1.125rem;
            font-weight: 600;
            color: #2d3748;
        }

        .stat-value.large {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .gem-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .gem-item {
            padding: 12px;
            background-color: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            font-size: 0.875rem;
            color: #2d3748;
        }

        .gem-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .gem-item-number {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .gem-item-stats {
            font-weight: 600;
        }

        .gem-item-options {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-left: 28px;
        }

        .gem-item-option {
            color: #4a5568;
        }

        .hidden {
            display: none;
        }

        .file-input {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .form-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .form-field {
                width: 100%;
            }
            
            .gem-grid, .results {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ì•„í¬ê·¸ë¦¬ë“œ ìµœì í™” ì‹œë®¬ë ˆì´í„°</h1>
            <p>ë°ì´í„°ëŠ” ì§ˆì„œ ë”°ë¡œ í˜¼ëˆ ë”°ë¡œ ì €ì¥í•´ì£¼ì„¸ìš”</p>
            
            <!-- Page Switcher -->
            <div class="page-switcher">
                <button id="orderBtn" class="active">âš–ï¸ ì§ˆì„œ</button>
                <button id="chaosBtn">ğŸŒªï¸ í˜¼ëˆ</button>
            </div>
            
            <!-- Controls -->
            <div class="controls">
                <button class="btn" onclick="exportData()">ğŸ’¾ ë°ì´í„° ì €ì¥</button>
                <label class="btn" for="importFile">ğŸ“ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</label>
                <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)">
                <button class="btn" onclick="resetData()">ğŸ”„ ë°ì´í„° ì´ˆê¸°í™”</button>
            </div>
        </div>

        <!-- Core Settings -->
        <div class="section">
            <h2 id="coreTitle">âš–ï¸ ì§ˆì„œ ì½”ì–´ ì„¤ì • (ìš°ì„ ìˆœìœ„ëŒ€ë¡œ)</h2>
            <div class="core-grid" id="coreGrid">
                <!-- Core cards will be generated here -->
            </div>
        </div>

        <!-- Gem Management -->
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 id="gemTitle">âš–ï¸ ì§ˆì„œ ì ¬ ê´€ë¦¬</h2>
                <button class="btn-primary" onclick="toggleAddForm()">+ ì ¬ ì¶”ê°€</button>
            </div>

            <!-- Add Gem Form -->
            <div id="addForm" class="add-form hidden">
                <h3 id="formTitle">ìƒˆ ì ¬ ì¶”ê°€</h3>
                <div class="form-row">
                    <div class="form-field small">
                        <label>ì˜ì§€ë ¥ ë¹„ìš©</label>
                        <input type="number" id="gemCost" value="1" min="1">
                    </div>
                    <div class="form-field small">
                        <label>í¬ì¸íŠ¸</label>
                        <input type="number" id="gemPoints" value="1" min="1">
                    </div>
                    <div class="form-field medium">
                        <label>ì˜µì…˜1 íƒ€ì…</label>
                        <select id="gemOption1">
                            <option value="ì•„êµ°í”¼í•´ê°•í™”">ì•„êµ°í”¼í•´ê°•í™”</option>
                            <option value="ì•„êµ°ê³µê²©ê°•í™”">ì•„êµ°ê³µê²©ê°•í™”</option>
                            <option value="ë‚™ì¸ë ¥">ë‚™ì¸ë ¥</option>
                            <option value="ê³µê²©ë ¥">ê³µê²©ë ¥</option>
                            <option value="ë³´ìŠ¤í”¼í•´">ë³´ìŠ¤í”¼í•´</option>
                            <option value="ì¶”ê°€í”¼í•´">ì¶”ê°€í”¼í•´</option>
                        </select>
                    </div>
                    <div class="form-field small">
                        <label>ì˜µì…˜1 ë ˆë²¨</label>
                        <input type="number" id="gemOption1Level" value="1" min="0" max="5">
                    </div>
                    <div class="form-field medium">
                        <label>ì˜µì…˜2 íƒ€ì…</label>
                        <select id="gemOption2">
                            <option value="ì•„êµ°í”¼í•´ê°•í™”">ì•„êµ°í”¼í•´ê°•í™”</option>
                            <option value="ì•„êµ°ê³µê²©ê°•í™”">ì•„êµ°ê³µê²©ê°•í™”</option>
                            <option value="ë‚™ì¸ë ¥">ë‚™ì¸ë ¥</option>
                            <option value="ê³µê²©ë ¥">ê³µê²©ë ¥</option>
                            <option value="ë³´ìŠ¤í”¼í•´">ë³´ìŠ¤í”¼í•´</option>
                            <option value="ì¶”ê°€í”¼í•´">ì¶”ê°€í”¼í•´</option>
                        </select>
                    </div>
                    <div class="form-field small">
                        <label>ì˜µì…˜2 ë ˆë²¨</label>
                        <input type="number" id="gemOption2Level" value="0" min="0" max="5">
                    </div>
                    <div class="form-buttons">
                        <button class="btn-secondary" onclick="cancelAdd()">ì·¨ì†Œ</button>
                        <button class="btn-primary" onclick="addGem()">ì¶”ê°€</button>
                    </div>
                </div>
            </div>

            <div class="gem-grid" id="gemGrid">
                <!-- Gem cards will be generated here -->
            </div>
        </div>

        <!-- Optimization Button -->
        <div class="optimize-btn">
            <button class="btn-optimize" onclick="optimize()" id="optimizeBtn">âš–ï¸ ì§ˆì„œ ìµœì í™” ì‹¤í–‰</button>
        </div>

        <!-- Results -->
        <div id="results" class="section hidden">
            <h2 id="resultsTitle">âš–ï¸ ì§ˆì„œ ìµœì  ì¡°í•© ê²°ê³¼</h2>
            <div class="results" id="resultsGrid">
                <!-- Results will be generated here -->
            </div>
        </div>
    </div>

    <script>
        // Constants
        const coreLimits = {
            'ì˜ì›…': 9,
            'ì „ì„¤': 12,
            'ìœ ë¬¼': 15,
            'ê³ ëŒ€': 17
        };

        const optionTypes = [
            'ì•„êµ°í”¼í•´ê°•í™”',
            'ì•„êµ°ê³µê²©ê°•í™”', 
            'ë‚™ì¸ë ¥',
            'ê³µê²©ë ¥',
            'ë³´ìŠ¤í”¼í•´',
            'ì¶”ê°€í”¼í•´'
        ];

        const optionLevelValues = {
            'ì•„êµ°í”¼í•´ê°•í™”': { 1: 0.95, 2: 1.89, 3: 2.84, 4: 3.79, 5: 4.73 },
            'ì•„êµ°ê³µê²©ê°•í™”': { 1: 2.27, 2: 4.73, 3: 7.19, 4: 9.65, 5: 11.74 },
            'ë‚™ì¸ë ¥': { 1: 1.52, 2: 3.22, 3: 4.92, 4: 6.62, 5: 8.14 },
            'ê³µê²©ë ¥': { 1: 1.0, 2: 2.0, 3: 3.0, 4: 4.0, 5: 5.0 },
            'ë³´ìŠ¤í”¼í•´': { 1: 0.8, 2: 1.6, 3: 2.4, 4: 3.2, 5: 4.0 },
            'ì¶”ê°€í”¼í•´': { 1: 0.3, 2: 0.6, 3: 0.9, 4: 1.2, 5: 1.5 }
        };

        const coreTypes = ['í•´ ì½”ì–´', 'ë‹¬ ì½”ì–´', 'ë³„ ì½”ì–´'];

        // State
        let currentPage = 'ì§ˆì„œ';
        let cores = [];
        let gems = [];
        let result = null;
        let editingGem = null;
        let nextGemId = 1;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            renderCores();
            renderGems();
            setupEventListeners();
        });

        // Event Listeners
        function setupEventListeners() {
            document.getElementById('orderBtn').addEventListener('click', () => switchPage('ì§ˆì„œ'));
            document.getElementById('chaosBtn').addEventListener('click', () => switchPage('í˜¼ëˆ'));
        }

        // Data Management
        function loadData() {
            const defaultCores = [
                { id: 1, name: 'ì½”ì–´ 1', type: 'í•´ ì½”ì–´', grade: 'ì˜ì›…', limit: 9 },
                { id: 2, name: 'ì½”ì–´ 2', type: 'ë‹¬ ì½”ì–´', grade: 'ì „ì„¤', limit: 12 },
                { id: 3, name: 'ì½”ì–´ 3', type: 'ë³„ ì½”ì–´', grade: 'ìœ ë¬¼', limit: 15 }
            ];
            const defaultGems = [
                { id: 1, gemNumber: 1, cost: 5, points: 5, option1: 'ì•„êµ°í”¼í•´ê°•í™”', option1Level: 1, option2: 'ì•„êµ°ê³µê²©ê°•í™”', option2Level: 2 }
            ];

            try {
                const savedCores = localStorage.getItem(`arkGrid${currentPage}Cores`);
                const savedGems = localStorage.getItem(`arkGrid${currentPage}Gems`);
                
                cores = savedCores ? JSON.parse(savedCores) : defaultCores;
                gems = savedGems ? JSON.parse(savedGems) : defaultGems;
                
                // Update nextGemId
                nextGemId = Math.max(...gems.map(g => g.id), 0) + 1;
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                cores = defaultCores;
                gems = defaultGems;
            }
        }

        function saveData() {
            localStorage.setItem(`arkGrid${currentPage}Cores`, JSON.stringify(cores));
            localStorage.setItem(`arkGrid${currentPage}Gems`, JSON.stringify(gems));
        }

        function switchPage(page) {
            currentPage = page;
            loadData();
            renderCores();
            renderGems();
            updatePageUI();
        }

        function updatePageUI() {
            const isOrder = currentPage === 'ì§ˆì„œ';
            document.getElementById('orderBtn').classList.toggle('active', isOrder);
            document.getElementById('chaosBtn').classList.toggle('active', !isOrder);
            
            document.getElementById('coreTitle').textContent = `${isOrder ? 'âš–ï¸ ì§ˆì„œ' : 'ğŸŒªï¸ í˜¼ëˆ'} ì½”ì–´ ì„¤ì • (ìš°ì„ ìˆœìœ„ëŒ€ë¡œ)`;
            document.getElementById('gemTitle').textContent = `${isOrder ? 'âš–ï¸ ì§ˆì„œ' : 'ğŸŒªï¸ í˜¼ëˆ'} ì ¬ ê´€ë¦¬`;
            document.getElementById('optimizeBtn').textContent = `${isOrder ? 'âš–ï¸ ì§ˆì„œ' : 'ğŸŒªï¸ í˜¼ëˆ'} ìµœì í™” ì‹¤í–‰`;
            document.getElementById('resultsTitle').textContent = `${isOrder ? 'âš–ï¸ ì§ˆì„œ' : 'ğŸŒªï¸ í˜¼ëˆ'} ìµœì  ì¡°í•© ê²°ê³¼`;
        }

        // Core Management
        function renderCores() {
            const grid = document.getElementById('coreGrid');
            grid.innerHTML = cores.map(core => `
                <div class="core-card">
                    <div class="core-header">
                        <div class="core-icon ${core.type === 'í•´ ì½”ì–´' ? 'sun' : core.type === 'ë‹¬ ì½”ì–´' ? 'moon' : 'star'}"></div>
                        <h3 class="core-title">${core.name}</h3>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì½”ì–´ ì¢…ë¥˜</label>
                        <select class="form-select" onchange="updateCoreType(${core.id}, this.value)">
                            ${coreTypes.map(type => `<option value="${type}" ${type === core.type ? 'selected' : ''}>${type}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ë“±ê¸‰</label>
                        <select class="form-select" onchange="updateCoreGrade(${core.id}, this.value)">
                            ${Object.keys(coreLimits).map(grade => `<option value="${grade}" ${grade === core.grade ? 'selected' : ''}>${grade}</option>`).join('')}
                        </select>
                    </div>
                    <div class="core-limit">
                        <span style="font-size: 0.875rem; color: #6b7280;">ì˜ì§€ë ¥ í•œë„</span>
                        <span style="font-size: 1.125rem; font-weight: 600; color: #2d3748;">${core.limit}</span>
                    </div>
                </div>
            `).join('');
        }

        function updateCoreType(coreId, type) {
            const core = cores.find(c => c.id === coreId);
            if (core) {
                core.type = type;
                saveData();
                renderCores();
            }
        }

        function updateCoreGrade(coreId, grade) {
            const core = cores.find(c => c.id === coreId);
            if (core) {
                core.grade = grade;
                core.limit = coreLimits[grade];
                saveData();
                renderCores();
            }
        }

        // Gem Management
        function renderGems() {
            const grid = document.getElementById('gemGrid');
            grid.innerHTML = gems.map(gem => `
                <div class="gem-card" onclick="toggleGemSelection(${gem.id})">
                    <div class="gem-number">${gem.gemNumber}</div>
                    <div class="gem-info">
                        <div class="gem-stats">
                            <span style="font-size: 0.875rem; color: #6b7280; font-weight: 500;">ì˜ì§€ë ¥: ${gem.cost}</span>
                            <span style="font-size: 0.875rem; color: #059669; font-weight: 500;">í¬ì¸íŠ¸: ${gem.points}</span>
                        </div>
                        <div class="gem-option">
                            <span class="gem-option-label">ì˜µì…˜1:</span>
                            <span class="gem-option-value">${gem.option1} Lv.${gem.option1Level}</span>
                        </div>
                        ${gem.option2Level > 0 ? `
                        <div class="gem-option">
                            <span class="gem-option-label">ì˜µì…˜2:</span>
                            <span class="gem-option-value">${gem.option2} Lv.${gem.option2Level}</span>
                        </div>
                        ` : ''}
                        <div class="gem-total">
                            <span class="gem-total-value">ì´ ì¦ê°€ëŸ‰: ${calculateGemPower(gem).toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="gem-actions">
                        <button class="btn-small btn-edit" onclick="event.stopPropagation(); editGem(${gem.id})">í¸ì§‘</button>
                        <button class="btn-small btn-delete" onclick="event.stopPropagation(); deleteGem(${gem.id})">ì‚­ì œ</button>
                    </div>
                </div>
            `).join('');
        }

        function toggleGemSelection(gemId) {
            // This would be used for manual gem selection if needed
            console.log('Toggle gem selection:', gemId);
        }

        function toggleAddForm() {
            const form = document.getElementById('addForm');
            form.classList.toggle('hidden');
            if (!form.classList.contains('hidden')) {
                resetForm();
            }
        }

        function resetForm() {
            document.getElementById('gemCost').value = 1;
            document.getElementById('gemPoints').value = 1;
            document.getElementById('gemOption1').value = 'ì•„êµ°í”¼í•´ê°•í™”';
            document.getElementById('gemOption1Level').value = 1;
            document.getElementById('gemOption2').value = 'ì•„êµ°ê³µê²©ê°•í™”';
            document.getElementById('gemOption2Level').value = 0;
            document.getElementById('formTitle').textContent = 'ìƒˆ ì ¬ ì¶”ê°€';
            editingGem = null;
        }

        function addGem() {
            const cost = parseInt(document.getElementById('gemCost').value) || 1;
            const points = parseInt(document.getElementById('gemPoints').value) || 1;
            const option1 = document.getElementById('gemOption1').value;
            const option1Level = parseInt(document.getElementById('gemOption1Level').value) || 0;
            const option2 = document.getElementById('gemOption2').value;
            const option2Level = parseInt(document.getElementById('gemOption2Level').value) || 0;

            const gemNumber = Math.max(...gems.map(g => g.gemNumber), 0) + 1;

            if (editingGem) {
                // Update existing gem
                const gem = gems.find(g => g.id === editingGem);
                if (gem) {
                    gem.cost = cost;
                    gem.points = points;
                    gem.option1 = option1;
                    gem.option1Level = option1Level;
                    gem.option2 = option2;
                    gem.option2Level = option2Level;
                }
            } else {
                // Add new gem
                const gem = {
                    id: nextGemId++,
                    gemNumber: gemNumber,
                    cost: cost,
                    points: points,
                    option1: option1,
                    option1Level: option1Level,
                    option2: option2,
                    option2Level: option2Level
                };
                gems.push(gem);
            }

            saveData();
            renderGems();
            document.getElementById('addForm').classList.add('hidden');
        }

        function editGem(gemId) {
            const gem = gems.find(g => g.id === gemId);
            if (gem) {
                editingGem = gemId;
                document.getElementById('gemCost').value = gem.cost;
                document.getElementById('gemPoints').value = gem.points;
                document.getElementById('gemOption1').value = gem.option1;
                document.getElementById('gemOption1Level').value = gem.option1Level;
                document.getElementById('gemOption2').value = gem.option2;
                document.getElementById('gemOption2Level').value = gem.option2Level;
                document.getElementById('formTitle').textContent = 'ì ¬ í¸ì§‘';
                document.getElementById('addForm').classList.remove('hidden');
            }
        }

        function deleteGem(gemId) {
            if (confirm('ì´ ì ¬ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                gems = gems.filter(g => g.id !== gemId);
                saveData();
                renderGems();
            }
        }

        function cancelAdd() {
            document.getElementById('addForm').classList.add('hidden');
            resetForm();
        }

        // Optimization
        function calculateGemPower(gem) {
            let power = 0;
            
            if (gem.option1Level > 0 && gem.option1Level <= 5 && 
                !['ê³µê²©ë ¥', 'ë³´ìŠ¤í”¼í•´', 'ì¶”ê°€í”¼í•´'].includes(gem.option1)) {
                power += optionLevelValues[gem.option1][gem.option1Level] || 0;
            }
            
            if (gem.option2Level > 0 && gem.option2Level <= 5 && 
                !['ê³µê²©ë ¥', 'ë³´ìŠ¤í”¼í•´', 'ì¶”ê°€í”¼í•´'].includes(gem.option2)) {
                power += optionLevelValues[gem.option2][gem.option2Level] || 0;
            }
            
            return power;
        }

        function calculateCorePoints(gems) {
            return gems.reduce((total, gem) => total + gem.points, 0);
        }

        function isCoreEffectActive(points) {
            return [10, 14, 17, 18, 19, 20].includes(points);
        }

        function getPointPriority(points) {
            if (points >= 20) return 6;
            if (points >= 19) return 5;
            if (points >= 18) return 4;
            if (points >= 17) return 3;
            if (points >= 14) return 2;
            if (points >= 10) return 1;
            return 0;
        }

        function getCombinations(arr, k) {
            if (k === 0) return [[]];
            if (arr.length === 0) return [];
            const [first, ...rest] = arr;
            const withFirst = getCombinations(rest, k - 1).map(c => [first, ...c]);
            const withoutFirst = getCombinations(rest, k);
            return [...withFirst, ...withoutFirst];
        }

        function canReplaceGem(currentGem, newGem, currentCorePoints) {
            if (currentGem.cost !== newGem.cost) return false;
            if (newGem.points < currentGem.points) return false;
            if (currentGem.id === newGem.id) return false;
            return true;
        }

        function findBetterReplacement(currentGems, currentCorePoints, availableGems) {
            let bestReplacement = null;
            let maxImprovement = 0;
            
            const currentCoreGemIds = new Set(currentGems.map(gem => gem.id));
            
            currentGems.forEach((currentGem, index) => {
                availableGems.forEach(newGem => {
                    if (canReplaceGem(currentGem, newGem, currentCorePoints) && 
                        !currentCoreGemIds.has(newGem.id)) {
                        const currentPower = calculateGemPower(currentGem);
                        const newPower = calculateGemPower(newGem);
                        const improvement = newPower - currentPower;
                        
                        if (improvement > maxImprovement) {
                            maxImprovement = improvement;
                            bestReplacement = {
                                index: index,
                                oldGem: currentGem,
                                newGem: newGem,
                                improvement: improvement
                            };
                        }
                    }
                });
            });
            
            return bestReplacement;
        }

        function optimize() {
            const results = [];
            const usedGems = new Set();
            
            console.log('=== ìµœì í™” ì‹œì‘ ===');
            console.log('ì´ ì ¬ ìˆ˜:', gems.length);
            
            cores.forEach((core, coreIndex) => {
                console.log(`\n--- ì½”ì–´ ${coreIndex + 1} (${core.name}) ìµœì í™” ---`);
                
                const availableGems = gems.filter(gem => !usedGems.has(gem.id));
                console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ì ¬ ìˆ˜:', availableGems.length);
                
                let bestCombo = null;

                for (let gemCount = 1; gemCount <= 4; gemCount++) {
                    const allCombos = getCombinations(availableGems, gemCount);
                    
                    allCombos.forEach(combo => {
                        const totalCost = combo.reduce((s, g) => s + g.cost, 0);
                        if (totalCost <= core.limit) {
                            const totalPower = combo.reduce((s, g) => s + calculateGemPower(g), 0);
                            const corePoints = calculateCorePoints(combo);
                            const isEffectActive = isCoreEffectActive(corePoints);
                            const pointPriority = getPointPriority(corePoints);
                            
                            let isBetter = false;
                            if (!bestCombo) {
                                isBetter = true;
                            } else {
                                const bestIsEffectActive = isCoreEffectActive(calculateCorePoints(bestCombo.gems));
                                const bestPointPriority = getPointPriority(calculateCorePoints(bestCombo.gems));
                                
                                if (isEffectActive && !bestIsEffectActive) {
                                    isBetter = true;
                                } else if (isEffectActive === bestIsEffectActive) {
                                    if (isEffectActive) {
                                        isBetter = pointPriority > bestPointPriority;
                                    } else {
                                        isBetter = totalPower > bestCombo.power;
                                    }
                                }
                            }
                            
                            if (isBetter) {
                                bestCombo = { 
                                    gems: combo, 
                                    power: totalPower, 
                                    cost: totalCost, 
                                    core: core,
                                    corePoints: corePoints,
                                    isEffectActive: isEffectActive,
                                    pointPriority: pointPriority
                                };
                            }
                        }
                    });
                }

                if (bestCombo) {
                    console.log('ì„ íƒëœ ì ¬ ì¡°í•©:', bestCombo.gems.map(g => ({ id: g.id, gemNumber: g.gemNumber })));
                    
                    bestCombo.gems.forEach(gem => {
                        usedGems.add(gem.id);
                    });
                    
                    // Gem replacement optimization
                    let improvedCombo = { ...bestCombo };
                    let hasImprovement = true;
                    
                    while (hasImprovement) {
                        const unusedGems = gems.filter(gem => !usedGems.has(gem.id));
                        
                        const replacement = findBetterReplacement(
                            improvedCombo.gems, 
                            improvedCombo.corePoints, 
                            unusedGems
                        );
                        
                        if (replacement && replacement.improvement > 0) {
                            console.log(`ì ¬ êµì²´: ì ¬ ${replacement.oldGem.gemNumber} â†’ ì ¬ ${replacement.newGem.gemNumber}`);
                            
                            const newGems = [...improvedCombo.gems];
                            newGems[replacement.index] = replacement.newGem;
                            
                            const newCorePoints = calculateCorePoints(newGems);
                            const newPower = newGems.reduce((s, g) => s + calculateGemPower(g), 0);
                            const newIsEffectActive = isCoreEffectActive(newCorePoints);
                            
                            improvedCombo = {
                                ...improvedCombo,
                                gems: newGems,
                                corePoints: newCorePoints,
                                power: newPower,
                                isEffectActive: newIsEffectActive
                            };
                            
                            usedGems.delete(replacement.oldGem.id);
                            usedGems.add(replacement.newGem.id);
                        } else {
                            hasImprovement = false;
                        }
                    }
                    
                    results.push(improvedCombo);
                }
            });

            result = results;
            renderResults();
        }

        function renderResults() {
            const resultsSection = document.getElementById('results');
            const resultsGrid = document.getElementById('resultsGrid');
            
            if (result && result.length > 0) {
                resultsSection.classList.remove('hidden');
                resultsGrid.innerHTML = result.map((combo, index) => `
                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-icon ${combo.core.type === 'í•´ ì½”ì–´' ? 'sun' : combo.core.type === 'ë‹¬ ì½”ì–´' ? 'moon' : 'star'}"></div>
                            <h3 class="result-title">${combo.core.name} (${combo.core.type})</h3>
                        </div>
                        
                        <div class="result-stats">
                            <div class="stat-group">
                                <div class="stat-label">ì´ ì „íˆ¬ë ¥</div>
                                <div class="stat-value large">${combo.power.toFixed(2)}</div>
                            </div>
                            <div class="stat-group">
                                <div class="stat-label">ì½”ì–´ í¬ì¸íŠ¸</div>
                                <div class="stat-value">${combo.corePoints}</div>
                            </div>
                            <div class="stat-group">
                                <div class="stat-label">ì‚¬ìš© ì˜ì§€ë ¥</div>
                                <div class="stat-value">${combo.cost}/${combo.core.limit}</div>
                            </div>
                        </div>

                        <div>
                            <h4 style="font-size: 1rem; font-weight: 600; margin: 0 0 12px 0; color: #4a5568;">í¬í•¨ëœ ì ¬</h4>
                            <div class="gem-list">
                                ${combo.gems.map(g => `
                                    <div class="gem-item">
                                        <div class="gem-item-header">
                                            <div class="gem-item-number">${g.gemNumber}</div>
                                            <span class="gem-item-stats">ì˜ì§€ë ¥: ${g.cost}, í¬ì¸íŠ¸: ${g.points}</span>
                                        </div>
                                        <div class="gem-item-options">
                                            <div class="gem-item-option">ì˜µì…˜1: ${g.option1} Lv.${g.option1Level}</div>
                                            ${g.option2Level > 0 ? `<div class="gem-item-option">ì˜µì…˜2: ${g.option2} Lv.${g.option2Level}</div>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                resultsSection.classList.add('hidden');
            }
        }

        // Export/Import
        function exportData() {
            const data = {
                gems: gems,
                cores: cores,
                pageType: currentPage,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ark-grid-${currentPage === 'ì§ˆì„œ' ? 'order' : 'chaos'}-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.gems && importedData.cores) {
                        gems = importedData.gems;
                        cores = importedData.cores;
                        nextGemId = Math.max(...gems.map(g => g.id), 0) + 1;
                        saveData();
                        renderCores();
                        renderGems();
                        alert(`${currentPage} í˜ì´ì§€ì˜ ì ¬ ë°ì´í„°ì™€ ì½”ì–´ ì„¤ì •ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                    } else if (Array.isArray(importedData)) {
                        gems = importedData;
                        nextGemId = Math.max(...gems.map(g => g.id), 0) + 1;
                        saveData();
                        renderGems();
                        alert(`${currentPage} í˜ì´ì§€ì˜ ì ¬ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                    } else {
                        alert('ì˜¬ë°”ë¥¸ ë°ì´í„° í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
                    }
                } catch (error) {
                    alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function resetData() {
            if (confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                localStorage.removeItem(`arkGrid${currentPage}Cores`);
                localStorage.removeItem(`arkGrid${currentPage}Gems`);
                location.reload();
            }
        }
    </script>
</body>
</html>
